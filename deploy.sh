#!/bin/bash

# ğŸš€ Home Assistant Stundenplan Card - Build & Deploy Script
# Baut die Card, committed zu Git und erstellt Release fÃ¼r HACS

set -e  # Exit bei Fehlern

# Farben fÃ¼r Output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Funktionen
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Header
echo -e "${BLUE}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘         ğŸ  HA Stundenplan Card Deployment            â•‘"
echo "â•‘              Build â†’ Git â†’ HACS Ready                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# PrÃ¼fe ob wir im richtigen Verzeichnis sind
if [ ! -f "package.json" ]; then
    log_error "package.json nicht gefunden. Sind Sie im Projektverzeichnis?"
    exit 1
fi

# PrÃ¼fe Git Repository
if [ ! -d ".git" ]; then
    log_warning "Kein Git Repository gefunden. Initialisiere..."
    git init
    log_success "Git Repository initialisiert"
fi

# Lese aktuelle Version aus package.json
CURRENT_VERSION=$(grep '"version"' package.json | sed 's/.*"version": *"\([^"]*\)".*/\1/')
log_info "Aktuelle Version: $CURRENT_VERSION"

# Frage nach neuer Version
echo ""
read -p "ğŸ·ï¸  Neue Version (aktuell: $CURRENT_VERSION, Enter fÃ¼r Auto-Increment): " NEW_VERSION

if [ -z "$NEW_VERSION" ]; then
    # Auto-increment patch version
    IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
    MAJOR=${VERSION_PARTS[0]}
    MINOR=${VERSION_PARTS[1]}
    PATCH=${VERSION_PARTS[2]}
    NEW_PATCH=$((PATCH + 1))
    NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
fi

log_info "Neue Version wird: $NEW_VERSION"

# Update package.json version
log_info "Aktualisiere package.json Version..."
sed -i.bak "s/\"version\": *\"[^\"]*\"/\"version\": \"$NEW_VERSION\"/" package.json
rm -f package.json.bak
log_success "Version in package.json aktualisiert"

# Update hacs.json version
if [ -f "hacs.json" ]; then
    log_info "Aktualisiere hacs.json Version..."
    sed -i.bak "s/\"version\": *\"[^\"]*\"/\"version\": \"$NEW_VERSION\"/" hacs.json
    rm -f hacs.json.bak
    log_success "Version in hacs.json aktualisiert"
fi

# PrÃ¼fe Node.js Installation
if command -v node &> /dev/null; then
    log_info "Installiere Dependencies..."
    npm install
    log_success "Dependencies installiert"
    
    log_info "Baue Card..."
    npm run build
    
    if [ -f "dist/ha-stundenplan-card.js" ]; then
        log_success "Card erfolgreich gebaut!"
        
        # Kopiere fÃ¼r HACS ins Root-Verzeichnis
        cp dist/ha-stundenplan-card.js ./
        log_success "Card fÃ¼r HACS ins Root-Verzeichnis kopiert"
        
        # Zeige DateigrÃ¶ÃŸe
        SIZE=$(wc -c < "dist/ha-stundenplan-card.js")
        SIZE_KB=$((SIZE / 1024))
        log_info "GrÃ¶ÃŸe der gebauten Card: ${SIZE_KB}KB"
    else
        log_error "Build fehlgeschlagen!"
        exit 1
    fi
else
    log_warning "Node.js nicht installiert. Verwende Pre-Built Version..."
    if [ ! -f "dist/ha-stundenplan-card.js" ]; then
        log_error "Keine gebaute Card gefunden und Node.js nicht verfÃ¼gbar!"
        exit 1
    fi
fi

# Git Status prÃ¼fen
echo ""
log_info "Git Status:"
git status --porcelain

# Add alle Ã„nderungen
log_info "FÃ¼ge Ã„nderungen zu Git hinzu..."
git add .

# Commit Message
COMMIT_MSG="ğŸš€ Release v$NEW_VERSION

- Updated version to $NEW_VERSION
- Built card for distribution
- Ready for HACS installation

Auto-generated by deploy script"

# Commit
log_info "Erstelle Commit..."
git commit -m "$COMMIT_MSG" || log_warning "Nichts zu committen oder Commit fehlgeschlagen"

# PrÃ¼fe Remote
if git remote get-url origin &> /dev/null; then
    REMOTE_URL=$(git remote get-url origin)
    log_info "Git Remote gefunden: $REMOTE_URL"
    
    # Push zum Main Branch
    CURRENT_BRANCH=$(git branch --show-current)
    log_info "Pushe zu Branch: $CURRENT_BRANCH"
    
    git push origin $CURRENT_BRANCH
    log_success "Code zu Git Repository gepusht!"
    
    # Erstelle Git Tag
    log_info "Erstelle Git Tag v$NEW_VERSION..."
    git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
    git push origin "v$NEW_VERSION"
    log_success "Git Tag erstellt und gepusht!"
    
    echo ""
    echo -e "${GREEN}ğŸ‰ DEPLOYMENT ERFOLGREICH! ğŸ‰${NC}"
    echo ""
    echo "ğŸ“¦ Version: $NEW_VERSION"
    echo "ğŸ”— Repository: $REMOTE_URL"
    echo "ğŸ·ï¸  Tag: v$NEW_VERSION"
    echo ""
    echo "ğŸ“‹ NÃ¤chste Schritte fÃ¼r HACS:"
    echo "1. Gehe zu deinem GitHub Repository"
    echo "2. Erstelle ein Release von Tag v$NEW_VERSION"
    echo "3. Lade ha-stundenplan-card.js als Asset hoch"
    echo "4. FÃ¼ge Repository zu HACS als Custom Repository hinzu"
    echo ""
    echo "ğŸ”— HACS Custom Repository URL:"
    echo "   $REMOTE_URL"
    echo ""
    
else
    log_warning "Kein Git Remote konfiguriert!"
    echo ""
    echo "ğŸ”§ Konfiguriere Git Remote:"
    echo "git remote add origin https://github.com/IHR-BENUTZERNAME/ha-stundenplan-card.git"
    echo ""
    echo "ğŸ“¤ Dann erneut ausfÃ¼hren:"
    echo "./deploy.sh"
fi

# GitHub CLI Integration (falls verfÃ¼gbar)
if command -v gh &> /dev/null; then
    echo ""
    read -p "ğŸš€ GitHub Release automatisch erstellen? (y/n): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "Erstelle GitHub Release..."
        
        RELEASE_NOTES="## ğŸ†• Version $NEW_VERSION

### Features
- Konfigurierbare Stundenplan-Anzeige
- Server-URL, Username, Password und HÃ¶he einstellbar
- Responsive Design mit Home Assistant Themes
- Grafischer Konfigurations-Editor

### Installation
1. FÃ¼ge dieses Repository als Custom Repository zu HACS hinzu
2. Installiere 'Stundenplan Card' Ã¼ber HACS
3. FÃ¼ge die Card zu deinem Dashboard hinzu

### Konfiguration
\`\`\`yaml
type: custom:ha-stundenplan-card
server: \"https://ihr-stundenplan-server.de\"
username: \"ihr-benutzername\"
password: \"ihr-passwort\"
height: 400
\`\`\`"

        gh release create "v$NEW_VERSION" \
            --title "ğŸ• Stundenplan Card v$NEW_VERSION" \
            --notes "$RELEASE_NOTES" \
            "dist/ha-stundenplan-card.js#Home Assistant Stundenplan Card"
            
        log_success "GitHub Release erstellt!"
        
        # HACS Repository Info
        echo ""
        echo -e "${BLUE}ğŸ“‹ HACS Repository Information:${NC}"
        REPO_URL=$(gh repo view --json url --jq .url)
        echo "Repository URL: $REPO_URL"
        echo "Category: Lovelace"
        echo "Type: JavaScript Module"
    fi
fi

echo ""
log_success "ğŸ¯ Deployment abgeschlossen!"